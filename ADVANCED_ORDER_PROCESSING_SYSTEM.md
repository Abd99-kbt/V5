# نظام معالجة الطلبات المتقدم

## نظرة عامة

تم تطوير نظام معالجة الطلبات المتقدم لدعم السيناريو المعقد لإدارة المواد والطلبات كما هو مطلوب. يتضمن النظام تتبع دقيق للأوزان في كل مرحلة، وإدارة الهدر، وحساب التأثير على الأسعار.

## الميزات الرئيسية

### 1. تتبع الأوزان الدقيق
- **الوزن المطلوب**: الوزن المطلوب من الزبون
- **الوزن المستخرج**: الوزن الفعلي المستخرج من المستودع
- **الوزن المفرز**: الوزن بعد مرحلة الفرز
- **الوزن المقصوص**: الوزن بعد مرحلة القص
- **الوزن المسلم**: الوزن الفعلي المسلم للزبون
- **الوزن المهدور**: الوزن المهدور في كل مرحلة
- **الوزن المعاد**: الوزن المعاد للمستودع

### 2. مراحل المعالجة
1. **إنشاء الطلب**: إنشاء الطلب وإضافة المواد
2. **مراجعة الطلب**: مراجعة الطلب والموافقة عليه
3. **حجز المواد**: استخراج المواد من المستودعات
4. **الفرز**: فرز المواد وتصنيفها
5. **القس**: قص المواد حسب المواصفات المطلوبة
6. **التعبئة**: تعبئة المواد للشحن
7. **الفوترة**: إصدار الفاتورة
8. **التسليم**: تسليم المواد للزبون

### 3. إدارة الهدر
- تتبع الهدر في كل مرحلة
- حساب نسبة الهدر
- تسجيل أسباب الهدر
- حساب التأثير المالي للهدر
- إجراءات الوقاية والتصحيح

### 4. نظام التسعير المتقدم
- حساب القيمة الأساسية
- إضافة تكاليف القص والفرز
- حساب تأثير الهدر على السعر
- تطبيق الخصومات
- حساب القيمة النهائية

## الهيكل التقني

### الجداول الجديدة

#### 1. order_materials
جدول ربط الطلبات بالمواد مع تفاصيل المعالجة:
```sql
- order_id: معرف الطلب
- material_id: معرف المادة
- requested_weight: الوزن المطلوب
- extracted_weight: الوزن المستخرج
- sorted_weight: الوزن المفرز
- cut_weight: الوزن المقصوص
- delivered_weight: الوزن المسلم
- waste_weight: وزن الهدر
- selling_price_per_ton: سعر البيع للطن
- final_value: القيمة النهائية
```

#### 2. material_movements
جدول تتبع حركة المواد:
```sql
- material_id: معرف المادة
- order_id: معرف الطلب
- movement_type: نوع الحركة
- weight: الوزن المتحرك
- from_warehouse_id: المستودع المصدر
- to_warehouse_id: المستودع المقصد
- stage: المرحلة
- waste_weight: وزن الهدر
- performed_by: المستخدم المنفذ
```

#### 3. waste_tracking
جدول تتبع الهدر:
```sql
- material_id: معرف المادة
- order_id: معرف الطلب
- waste_type: نوع الهدر
- waste_category: فئة الهدر
- waste_weight: وزن الهدر
- waste_percentage: نسبة الهدر
- waste_cost: تكلفة الهدر
- lost_revenue: الإيراد المفقود
- total_impact: التأثير الإجمالي
- waste_reason: سبب الهدر
```

### النماذج المحدثة

#### 1. Material Model
```php
// حقول جديدة
- total_weight: إجمالي الوزن الأصلي
- current_weight: الوزن الحالي المتاح
- waste_weight: الوزن المهدور
- transferred_weight: الوزن المنقول
- current_stage: المرحلة الحالية
- current_warehouse_id: المستودع الحالي

// وظائف جديدة
- extractFromWarehouse(): استخراج من المستودع
- transferToSorting(): نقل للفرز
- transferToCutting(): نقل للقس
- recordWaste(): تسجيل الهدر
- returnToWarehouse(): إرجاع للمستودع
- isWeightBalanced(): التحقق من التوازن
```

#### 2. Order Model
```php
// وظائف جديدة
- addMaterial(): إضافة مادة للطلب
- extractMaterials(): استخراج المواد
- transferToSorting(): نقل للفرز
- recordSorting(): تسجيل الفرز
- transferToCutting(): نقل للقس
- recordCutting(): تسجيل القس
- recordDelivery(): تسجيل التسليم
- isWeightBalanced(): التحقق من التوازن
- calculateTotalWaste(): حساب إجمالي الهدر
```

## واجهات المستخدم

### 1. صفحة معالجة الطلبات
- عرض جميع الطلبات قيد المعالجة
- فلاتر البحث والتصفية
- إجراءات سريعة للطلبات

### 2. صفحة تفاصيل الطلب
- عرض معلومات الطلب
- مراحل المعالجة
- جدول المواد مع الأوزان
- أزرار الإجراءات لكل مرحلة

### 3. النوافذ المنبثقة (Modals)
- **استخراج المواد**: استخراج المواد من المستودعات
- **تسجيل الفرز**: تسجيل نتائج الفرز والهدر
- **تسجيل القس**: تسجيل نتائج القس والهدر
- **تسجيل التسليم**: تسجيل التسليم للزبون
- **تقرير التوازن**: عرض توازن الأوزان
- **إحصائيات الهدر**: عرض إحصائيات الهدر
- **حركات المواد**: عرض تاريخ حركات المواد
- **تتبع الهدر**: عرض تفاصيل الهدر

## سير العمل

### 1. إنشاء الطلب
```php
$order = Order::create([...]);
$order->addMaterial($materialId, $requestedWeight, $sellingPrice, $options);
```

### 2. استخراج المواد
```php
$order->extractMaterials($userId);
// أو استخراج مادة واحدة
$material->extractFromWarehouse($weight, $orderId, $userId);
```

### 3. الفرز
```php
$order->transferToSorting($userId, $sortingWarehouseId);
$order->recordSorting($sortingData, $userId);
```

### 4. القس
```php
$order->transferToCutting($userId, $cuttingWarehouseId);
$order->recordCutting($cuttingData, $userId);
```

### 5. التسليم
```php
$order->recordDelivery($deliveryData, $userId);
```

## التحقق من التوازن

النظام يتحقق من توازن الأوزان في كل مرحلة:

```php
// التحقق من توازن المادة
$material->isWeightBalanced();

// التحقق من توازن الطلب
$order->isWeightBalanced();

// الحصول على تقرير التوازن
$report = $order->getWeightBalanceReport();
```

## إدارة الهدر

### تسجيل الهدر
```php
$material->recordWaste($wasteWeight, $stage, $reason, $userId, $orderId);
```

### حساب التأثير
```php
$wasteImpact = $material->calculateWasteImpactOnPrice();
$totalWaste = $order->calculateTotalWaste();
```

## التقارير والإحصائيات

### 1. تقرير توازن الأوزان
- عرض الأوزان في كل مرحلة
- التحقق من التوازن
- حساب الفروقات

### 2. إحصائيات الهدر
- إجمالي الهدر
- نسبة الهدر
- تكلفة الهدر
- توزيع الهدر حسب المرحلة

### 3. حركات المواد
- تاريخ جميع الحركات
- تفاصيل كل حركة
- التحقق من التوازن

### 4. تتبع الهدر
- تفاصيل كل حالة هدر
- أسباب الهدر
- إجراءات الوقاية

## الأمان والصلاحيات

النظام يحترم نظام الصلاحيات الموجود:
- **أمين المستودع**: إدارة المواد والاستخراج
- **مسؤول الفرازة**: إدارة مرحلة الفرز
- **مسؤول القصاصة**: إدارة مرحلة القس
- **مسؤول التسليم**: إدارة التسليم
- **المحاسب**: إدارة الفواتير والأسعار

## الأداء والتحسين

### 1. الفهرسة
- فهارس على الحقول المستخدمة في البحث
- فهارس مركبة للاستعلامات المعقدة

### 2. التخزين المؤقت
- تخزين مؤقت للتقارير
- تخزين مؤقت للإحصائيات

### 3. التحسين
- استعلامات محسنة
- تحميل كسول للعلاقات
- تجميع البيانات

## الاختبار

### 1. اختبارات الوحدة
- اختبار النماذج
- اختبار الوظائف
- اختبار العلاقات

### 2. اختبارات التكامل
- اختبار سير العمل
- اختبار التحقق من التوازن
- اختبار إدارة الهدر

### 3. اختبارات الأداء
- اختبار الاستعلامات
- اختبار التحميل
- اختبار الذاكرة

## الصيانة والتطوير

### 1. الصيانة الدورية
- تنظيف البيانات القديمة
- تحسين الفهارس
- مراجعة الأداء

### 2. التطوير المستقبلي
- إضافة مراحل جديدة
- تحسين واجهات المستخدم
- إضافة تقارير جديدة

## الدعم والمساعدة

### 1. دليل المستخدم
- شرح كل مرحلة
- أمثلة عملية
- حل المشاكل الشائعة

### 2. الدعم التقني
- توثيق API
- أمثلة الكود
- أفضل الممارسات

## الخلاصة

النظام الجديد يوفر:
- تتبع دقيق للأوزان في كل مرحلة
- إدارة شاملة للهدر
- حساب دقيق للتأثير على الأسعار
- واجهات مستخدم سهلة الاستخدام
- تقارير وإحصائيات مفصلة
- نظام أمان ومرونة عالية

هذا النظام يلبي جميع متطلبات السيناريو المطلوب ويوفر أساساً قوياً للتطوير المستقبلي.
